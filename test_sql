SELECT
    FNM_LN_ID,
    LN_REVW_ID,
    CAST(LN_REVW_RMDATN_LTR_CREN_TM AS TIMESTAMP) AS LN_REVW_RMDATN_LTR_CREN_TM,
    CURRENT_USER AS REC_CREN_USR_ID,
    CURRENT_TIMESTAMP AS REC_CREN_DITM
FROM (
    SELECT
        LRRS.FNM_LN_ID,
        LR.LN_REVW_ID,
        LRRM.LN_REVW_RMDATN_LTR_CREN_TM,
        ROW_NUMBER() OVER (PARTITION BY LRRS.FNM_LN_ID ORDER BY LRRS.REC_CREN_TM DESC, LR.LN_REVW_ID DESC) AS LRRM_SEQ_NO
    FROM
        (
            SELECT
                LRRS.FNM_LN_ID,
                LRRS.LN_REVW_ID,
                LRRS.REC_CREN_TM,
                LKUP.MD_DATA_ENUM_LKUP_OBJ_ID,
                DENSE_RANK() OVER (PARTITION BY LRRS.FNM_LN_ID, LRRS.LN_REVW_ID ORDER BY LRRS.LN_REVW_SELN_DT DESC) AS SEQ
            FROM
                ${RS_IDS_SCHEMA_NM}.LN_REVW_REFL_SELN LRRS
                JOIN ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP LKUP ON LRRS.LN_REVW_TI = LKUP.MD_DATA_ENUM_LKUP_OBJ_ID
            WHERE
                LRRS.MD_SRC_SYS_LKUP_OBJ_ID IN (9999)
                AND LRRS.LN_REVW_SELN_DT IS NOT NULL
                AND LKUP.DATA_ENUM_TP NOT IN ('PostForeclosureReview')
        ) LRRS
    JOIN ${RS_IDS_SCHEMA_NM}.LN_REVW LR ON LRRS.LN_REVW_ID = LR.LN_REVW_ID
    JOIN ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN LRRM ON LR.LN_REVW_ID = LRRM.LN_REVW_ID
    WHERE
        LRRS.SEQ = 1
    AND NOT EXISTS (
        SELECT 1
        FROM ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN LRRM_SUB
        JOIN ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP LKUP_SUB ON LRRM_SUB.LN_REVW_RMDATN_LTR_TI = LKUP_SUB.MD_DATA_ENUM_LKUP_OBJ_ID
        WHERE
            LRRM_SUB.LN_REVW_ID = LRRM.LN_REVW_ID
            AND LKUP_SUB.DATA_ENUM_TP IN ('Rescission')
    )
) AS FinalResult
WHERE
    LRRM_SEQ_NO = 1;
