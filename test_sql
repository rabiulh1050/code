SELECT
    FNM_LN_ID,
    LN_REVW_ID,
    CAST(LN_REVW_RMDATN_LTR_CREN_TM AS TIMESTAMP) AS LN_REVW_RMDATN_LTR_CREN_TM
FROM
    (
        SELECT
            LRRS.FNM_LN_ID,
            LR.LN_REVW_ID,
            LRRM.LN_REVW_RMDATN_LTR_CREN_TM,
            ROW_NUMBER() OVER (PARTITION BY LRRS.FNM_LN_ID ORDER BY LR.LN_REVW_ID DESC) AS LRRM_SEQ_NO
        FROM
            (
                SELECT
                    LRRS.FNM_LN_ID,
                    LRRS.LN_REVW_ID,
                    LRRS.REC_CREN_TM,
                    LRRS.LN_REVW_TI,
                    LRRS.MD_SRC_SYS_LKUP_OBJ_ID,
                    LRRS.LN_REVW_SELN_DT,
                    DENSE_RANK() OVER (PARTITION BY LRRS.FNM_LN_ID, LRRS.LN_REVW_ID ORDER BY LRRS.LN_REVW_SELN_DT DESC) AS SEQ
                FROM
                    ${RS_IDS_SCHEMA_NM}.LN_REVW_REFL_SELN LRRS
                JOIN
                    (
                        SELECT *
                        FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
                        WHERE DATA_ENUM_TP NOT IN ('PostForeclosureReview')
                    ) LKUP ON LKUP.MD_DATA_ENUM_LKUP_OBJ_ID = LRRS.LN_REVW_TI
                WHERE
                    LRRS.MD_SRC_SYS_LKUP_OBJ_ID = 9999
                    AND LRRS.LN_REVW_SELN_DT IS NOT NULL
            ) LRRS
        WHERE
            SEQ = 1
        JOIN
            ${RS_IDS_SCHEMA_NM}.LN_REVW LR ON LRRS.LN_REVW_ID = LR.LN_REVW_ID
        JOIN
            (
                SELECT
                    LRS.LN_REVW_ID,
                    LRS.MD_SRC_SYS_LKUP_OBJ_ID,
                    DENSE_RANK() OVER (PARTITION BY LRS.LN_REVW_ID ORDER BY LRS.LN_REVW_STAT_CHG_TM DESC) AS LRS_SEQ_NO
                FROM
                    ${RS_IDS_SCHEMA_NM}.LN_REVW_STAT LRS
                JOIN
                    ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP LKUP ON LRS.LN_REVW_STAT_TI = LKUP.MD_DATA_ENUM_LKUP_OBJ_ID
                WHERE
                    LRS.MD_SRC_SYS_LKUP_OBJ_ID = 9999
                    AND LKUP.DATA_ENUM_TP NOT IN ('ReviewClosed', 'ReviewCancelled')
            ) LRS ON LRRS.LN_REVW_ID = LRS.LN_REVW_ID AND LRRS.MD_SRC_SYS_LKUP_OBJ_ID = LRS.MD_SRC_SYS_LKUP_OBJ_ID AND LRS.LRS_SEQ_NO = 1
        JOIN
            (
                SELECT
                    LRRM.LN_REVW_ID,
                    LRRM.LN_REVW_RMDATN_LTR_TI,
                    LRRM.MD_SRC_SYS_LKUP_OBJ_ID,
                    LRRM.LN_REVW_RMDATN_LTR_CREN_TM,
                    ROW_NUMBER() OVER (PARTITION BY LRRM.LN_REVW_ID ORDER BY LRRM.LN_REVW_RMDATN_LTR_CREN_TM DESC) AS LRRM_FP_SEQ_NO
                FROM
                    ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN LRRM
                JOIN
                    ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP LKUP ON LRRM.LN_REVW_RMDATN_LTR_TI = LKUP.MD_DATA_ENUM_LKUP_OBJ_ID
                WHERE
                    LRRM.MD_SRC_SYS_LKUP_OBJ_ID = 9999
                    AND LKUP.DATA_ENUM_TP IN ('IndemnificationAgreement', 'RepurchaseAgreement', 'Repurchase', 'ReaffirmationFirst', 'ReaffirmationSecond', 'ReimbursementOfLosses', 'LoanQualityDefectNotice', 'RiskFreeAndRepurchaseAlternativeAgreement')
            ) LRRM ON LRRM.LN_REVW_ID = LRS.LN_REVW_ID AND LRRM.MD_SRC_SYS_LKUP_OBJ_ID = LRS.MD_SRC_SYS_LKUP_OBJ_ID AND LRRM.LRRM_FP_SEQ_NO = 1
    ) sub
WHERE
    LRRM_SEQ_NO = 1
    AND NOT EXISTS (
        SELECT 1
        FROM ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN LRRM
        JOIN ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP LKUP ON LRRM.LN_REVW_RMDATN_LIR_TI = LKUP.MD_DATA_ENUM_LKUP_OBJ_ID
        WHERE LKUP.DATA_ENUM_TP IN ('Rescission')
    );
