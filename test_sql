SELECT
    inner_LRRS.FNM_LN_ID,
    LR.LN_REVW_ID,
    CAST(LRRM.LN_REVW_RMDATN_LTR_CREN_TM AS TIMESTAMP) AS LN_REVW_RMDATN_LTR_CREN_TM
FROM
    (
        SELECT
            inner_LRRS.FNM_LN_ID,
            LR.LN_REVW_ID,
            LRRM.LN_REVW_RMDATN_LTR_CREN_TM,
            ROW_NUMBER() OVER (PARTITION BY inner_LRRS.FNM_LN_ID ORDER BY LR.LN_REVW_ID DESC) AS LRRM_SEQ_NO
        FROM
            (
                SELECT
                    FNM_LN_ID,
                    LN_REVW_ID,
                    MD_SRC_SYS_LKUP_OBJ_ID  -- Include this column for join condition
                FROM
                    (
                        SELECT
                            FNM_LN_ID,
                            LN_REVW_ID,
                            MD_SRC_SYS_LKUP_OBJ_ID,  -- Make sure this is included in the innermost select
                            LN_REVW_SELN_DT,
                            DENSE_RANK() OVER (PARTITION BY FNM_LN_ID, LN_REVW_ID ORDER BY LN_REVW_SELN_DT DESC) AS SEQ
                        FROM ${RS_IDS_SCHEMA_NM}.LN_REVW_REFL_SELN
                        WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
                          AND LN_REVW_SELN_DT IS NOT NULL
                    ) ranked_LRRS
                WHERE ranked_LRRS.SEQ = 1
            ) inner_LRRS
        JOIN ${RS_IDS_SCHEMA_NM}.LN_REVW LR ON inner_LRRS.LN_REVW_ID = LR.LN_REVW_ID
        JOIN
            (
                SELECT
                    LN_REVW_ID,
                    MD_SRC_SYS_LKUP_OBJ_ID
                FROM
                    (
                        SELECT
                            LN_REVW_ID,
                            MD_SRC_SYS_LKUP_OBJ_ID,
                            ROW_NUMBER() OVER (PARTITION BY LN_REVW_ID ORDER BY LN_REVW_STAT_CHG_TM DESC) AS RN
                        FROM ${RS_IDS_SCHEMA_NM}.LN_REVW_STAT
                        WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
                    ) filtered_LRS
                WHERE filtered_LRS.RN = 1
            ) LRS ON inner_LRRS.LN_REVW_ID = LRS.LN_REVW_ID AND inner_LRRS.MD_SRC_SYS_LKUP_OBJ_ID = LRS.MD_SRC_SYS_LKUP_OBJ_ID
        JOIN
            (
                SELECT
                    LN_REVW_ID,
                    LN_REVW_RMDATN_LTR_CREN_TM,
                    MD_SRC_SYS_LKUP_OBJ_ID
                FROM
                    (
                        SELECT
                            LN_REVW_ID,
                            LN_REVW_RMDATN_LTR_CREN_TM,
                            MD_SRC_SYS_LKUP_OBJ_ID,
                            ROW_NUMBER() OVER (PARTITION BY LN_REVW_ID ORDER BY LN_REVW_RMDATN_LTR_CREN_TM) AS RN
                        FROM ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN
                        WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
                    ) filtered_LRRM
                WHERE filtered_LRRM.RN = 1
            ) LRRM ON LRRM.LN_REVW_ID = LRS.LN_REVW_ID AND LRRM.MD_SRC_SYS_LKUP_OBJ_ID = LRS.MD_SRC_SYS_LKUP_OBJ_ID
    ) LRMST
WHERE
    LRMST.LRRM_SEQ_NO = 1
    AND NOT EXISTS
        (
            SELECT 1
            FROM ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN LRRM
            JOIN ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP LKUP ON LRRM.LN_REVW_RMDATN_LIR_TI = LKUP.MD_DATA_ENUM_LKUP_OBJ_ID
            WHERE LKUP.DATA_ENUM_TP IN ('Rescission')
        );
