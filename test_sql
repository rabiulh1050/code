SELECT
    LRRS.FNM_LN_ID,
    LR.LN_REVW_ID,
    CAST(LRRM.LN_REVW_RMDATN_LTR_CREN_TM AS TIMESTAMP) AS LN_REVW_RMDATN_LTR_CREN_TM
FROM
    (
        SELECT
            FNM_LN_ID,
            LN_REVW_ID,
            MD_SRC_SYS_LKUP_OBJ_ID
        FROM
            (
                SELECT
                    FNM_LN_ID,
                    LN_REVW_ID,
                    MD_SRC_SYS_LKUP_OBJ_ID,
                    LN_REVW_SELN_DT,
                    DENSE_RANK() OVER (PARTITION BY FNM_LN_ID, LN_REVW_ID ORDER BY LN_REVW_SELN_DT DESC) AS SEQ
                FROM 
                    ${RS_IDS_SCHEMA_NM}.LN_REVW_REFL_SELN
                WHERE 
                    MD_SRC_SYS_LKUP_OBJ_ID = 9999
                    AND LN_REVW_SELN_DT IS NOT NULL
            ) AS sub_LRRS
        WHERE 
            sub_LRRS.SEQ = 1
    ) AS LRRS
JOIN 
    ${RS_IDS_SCHEMA_NM}.LN_REVW LR ON LRRS.LN_REVW_ID = LR.LN_REVW_ID
JOIN
    (
        SELECT
            LN_REVW_ID,
            MD_SRC_SYS_LKUP_OBJ_ID
        FROM
            (
                SELECT
                    LN_REVW_ID,
                    MD_SRC_SYS_LKUP_OBJ_ID,
                    ROW_NUMBER() OVER (PARTITION BY LN_REVW_ID ORDER BY LN_REVW_STAT_CHG_TM DESC) AS RN
                FROM 
                    ${RS_IDS_SCHEMA_NM}.LN_REVW_STAT
                WHERE 
                    MD_SRC_SYS_LKUP_OBJ_ID = 9999
            ) AS sub_LRS
        WHERE 
            sub_LRS.RN = 1
    ) AS LRS ON LRRS.LN_REVW_ID = LRS.LN_REVW_ID AND LRRS.MD_SRC_SYS_LKUP_OBJ_ID = LRS.MD_SRC_SYS_LKUP_OBJ_ID
JOIN
    (
        SELECT
            LN_REVW_ID,
            LN_REVW_RMDATN_LTR_CREN_TM,
            MD_SRC_SYS_LKUP_OBJ_ID
        FROM
            (
                SELECT
                    LN_REVW_ID,
                    LN_REVW_RMDATN_LTR_CREN_TM,
                    MD_SRC_SYS_LKUP_OBJ_ID,
                    ROW_NUMBER() OVER (PARTITION BY LN_REVW_ID ORDER BY LN_REVW_RMDATN_LTR_CREN_TM) AS RN
                FROM 
                    ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN
                WHERE 
                    MD_SRC_SYS_LKUP_OBJ_ID = 9999
            ) AS sub_LRRM
        WHERE 
            sub_LRRM.RN = 1
    ) AS LRRM ON LRRM.LN_REVW_ID = LRS.LN_REVW_ID AND LRRM.MD_SRC_SYS_LKUP_OBJ_ID = LRS.MD_SRC_SYS_LKUP_OBJ_ID
WHERE 
    NOT EXISTS
        (
            SELECT 1
            FROM 
                ${RS_IDS_SCHEMA_NM}.LN_REVW_RMDATN sub_LRRM
            JOIN 
                ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP LKUP ON sub_LRRM.LN_REVW_RMDATN_LIR_TI = LKUP.MD_DATA_ENUM_LKUP_OBJ_ID
            WHERE 
                LKUP.DATA_ENUM_TP IN ('Rescission')
        );
