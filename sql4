WITH MD_DATA_ENUM AS (
    SELECT 
        DATA_ENUM_TP,
        DATA_ENUM_ED,
        MD_DATA_ENUM_LKUP_OBJ_ID,
        DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP AS MD_DATA_ENUM_LKUP_VW1
    WHERE MD_DATA_ENUM_LKUP_VW1.DATA_ENUM_ATTR_NM IN ('LPPPRDC_TI')
        AND MD_DATA_ENUM_LKUP_VW1.DATA_ENUM_TP = 'ReverseMortgage'
),
LN_LQDN_CTE AS (
    SELECT 
        LN_LQDN_VW1.FNM_LN_ID,
        CAST(LN_LQDN_VW1.BUS_EVNT_TM AS TIMESTAMP) AS BUS_EVNT_TM,
        LN_LQDN_VW1.ACVY_RPTG_PRD,
        CAST(LN_LQDN_VW1.ACVY_RPTG_PRD_DT AS TIMESTAMP) AS ACVY_RPTG_PRD_DT,
        LN_LQDN_VW1.BUS_EVNT_REVL_IC,
        LN_LQDN_VW1.LPPPRDC_TI,
        LN_LQDN_VW1.LQDD_UPB_AM,
        CAST(LN_LQDN_VW1.LQDN_EVNT_ACTN_DT AS TIMESTAMP) AS LQDN_EVNT_ACTN_DT,
        LN_LQDN_VW1.PDSC_RPURD_AM,
        LN_LQDN_VW1.ACTL_UPB_AM,
        LN_LQDN_VW1.TOT_LPTI_AM,
        LN_LQDN_VW1.MD_SRC_SYS_LKUP_OBJ_ID,
        DENSE_RANK() OVER (
            PARTITION BY LN_LQDN_VW1.FNM_LN_ID, LN_LQDN_VW1.ACVY_RPTG_PRD
            ORDER BY LN_LQDN_VW1.BUS_EVNT_TM DESC NULLS LAST
        ) AS SEQ
    FROM ${RS_IDS_SCHEMA_NM}.LN_LQDN AS LN_LQDN_VW1
    LEFT JOIN ${RS_IDS_SCHEMA_NM}.LN_STC AS LN_STC_VW1
        ON LN_LQDN_VW1.MD_SRC_SYS_LKUP_OBJ_ID = 9999
        AND LN_LQDN_VW1.FNM_LN_ID = LN_STC_VW1.FNM_LN_ID
        AND LN_STC_VW1.MD_SRC_SYS_LKUP_OBJ_ID = 9999
    WHERE LN_LQDN_VW1.SEQ = 1
),
LN_LQDN_VW1 AS (
    SELECT 
        LN_LQDN1.FNM_LN_ID,
        CAST(LN_LQDN1.BUS_EVNT_TM AS TIMESTAMP) AS BUS_EVNT_TM,
        LN_LQDN1.ACVY_RPTG_PRD,
        CAST(LN_LQDN1.ACVY_RPTG_PRD_DT AS TIMESTAMP) AS ACVY_RPTG_PRD_DT,
        LN_LQDN1.BUS_EVNT_REVL_IC,
        LN_LQDN1.ACTN_TI,
        LN_LQDN1.LPPPRDC_TI,
        LN_LQDN1.LQDD_UPB_AM,
        CAST(LN_LQDN1.LQDN_EVNT_ACTN_DT AS TIMESTAMP) AS LQDN_EVNT_ACTN_DT,
        LN_LQDN1.PDSC_RPURD_AM,
        LN_LQDN1.ACTL_UPB_AM,
        LN_LQDN1.TOT_LPTI_AM,
        LN_LQDN1.MD_SRC_SYS_LKUP_OBJ_ID,
        LN_LQDN1.SEQ
    FROM LN_LQDN_CTE AS LN_LQDN1
    WHERE LN_LQDN1.SEQ = 1
)
SELECT 
    LN_REVW_ST_SPST.LN_REVW_ST_SPST_OBJ_ID,
    LN_REVW_ST_SPST.FNM_LN_ID,
    LN_REVW_ST_SPST.LN_REVW_ID,
    CAST(LN_LQDN_VW1.BUS_EVNT_TM AS TIMESTAMP) AS BUS_EVNT_TM,
    CAST(LN_LQDN_VW1.ACVY_RPTG_PRD_DT AS TIMESTAMP) AS ACVY_RPTG_PRD_DT,
    LN_LQDN_VW1.BUS_EVNT_REVL_IC,
    LN_LQDN_VW1.ACTN_TI AS LN_ACTN_TYP,
    CAST(LN_LQDN_VW1.ACTN_TI AS NUMERIC) AS LN_ACTN_CD,
    LN_LQDN_VW1.LQDD_UPB_AM,
    CAST(LN_LQDN_VW1.LQDN_EVNT_ACTN_DT AS TIMESTAMP) AS LQDN_EVNT_ACTN_DT,
    LN_LQDN_VW1.ACVY_RPTG_PRD,
    NULL AS LN_ACTN_TYP_REF_VAL_CD,
    LN_LQDN_VW1.PDSC_RPURD_AM AS LN_PREM_DISC_RPURD_AMT,
    LN_LQDN_VW1.ACTL_UPB_AM AS LN_ACTL_UPB_AMT,
    LN_LQDN_VW1.TOT_LPTI_AM AS LN_TOT_LNDR_PASS_THRU_INT_AMT,
    LN_LQDN_VW1.MD_SRC_SYS_LKUP_OBJ_ID,
    LN_REVW_REFL_SELN_SPST.LN_REVW_SRC_SYS_EVNT_NME_TYP
FROM ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_REFL_SELN_SPST AS LN_REVW_REFL_SELN_SPST
JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST AS LN_REVW_ST_SPST
    ON LN_REVW_ST_SPST.LN_REVW_ID = LN_REVW_REFL_SELN_SPST.LN_REVW_ID
    AND LN_REVW_ST_SPST.FNM_LN_ID = LN_REVW_REFL_SELN_SPST.FNM_LN_ID
    AND LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP = 'IDS'
    AND LN_REVW_REFL_SELN_SPST.EVNT_NME_CD NOT IN ('3001', '3002', '3011', '3030')
JOIN LN_LQDN_VW1
    ON LN_LQDN_VW1.FNM_LN_ID = LN_REVW_REFL_SELN_SPST.FNM_LN_ID
JOIN MD_DATA_ENUM AS MD2
    ON MD2.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LQDN_VW1.LPPPRDC_TI
    AND MD2.DATA_ENUM_ATTR_NM = 'LPPPRDC_TI';
