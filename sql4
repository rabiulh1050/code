--n
WITH LN_LQDN_REVL_MAX_BUS_REC AS (
    SELECT 
        FNM_LN_ID, 
        CAST(BUS_EVNT_TM AS TIMESTAMP) AS BUS_EVNT_TM
    FROM (
        SELECT 
            FNM_LN_ID, 
            BUS_EVNT_TM, 
            DENSE_RANK() OVER (
                PARTITION BY FNM_LN_ID 
                ORDER BY BUS_EVNT_TM DESC NULLS LAST
            ) AS SEQ
        FROM ${RS_IDS_SCHEMA_NM}.LN_LQDN_REVL
        WHERE MD_SRC_SYS_LKUP_OBJ_ID IN (7007)
    ) AS LN_LQDN_REVL1
    WHERE SEQ = 1
),
LN_RISTMT_MAX_BUS_REC AS (
    SELECT 
        FNM_LN_ID, 
        CAST(BUS_EVNT_TM AS TIMESTAMP) AS BUS_EVNT_TM
    FROM (
        SELECT 
            FNM_LN_ID, 
            BUS_EVNT_TM, 
            DENSE_RANK() OVER (
                PARTITION BY FNM_LN_ID 
                ORDER BY BUS_EVNT_TM DESC NULLS LAST
            ) AS SEQ
        FROM ${RS_IDS_SCHEMA_NM}.LN_RISTMT
        WHERE MD_SRC_SYS_LKUP_OBJ_ID IN (9999)
    ) AS LN_RISTMT1
    WHERE SEQ = 1
),
LN_LQDN_LTST AS (
    SELECT 
        LN_LQDN.FNM_LN_ID,
        LN_LQDN.LN_REVW_ID,
        CAST(LN_LQDN.BUS_EVNT_TM AS TIMESTAMP) AS BUS_EVNT_TM,
        CAST(LN_LQDN.ACVY_RPTG_PRD_DT AS TIMESTAMP) AS ACVY_RPTG_PRD_DT,
        LN_LQDN.BUS_EVNT_REVL_IC,
        LN_LQDN.ACTN_TI AS LN_ACTN_TYP,
        CAST(LN_LQDN.ACTN_TI AS NUMERIC) AS LN_ACTN_CD,
        LN_LQDN.LQDD_UPB_AM,
        CAST(LN_LQDN.LQDN_EVNT_ACTN_DT AS TIMESTAMP) AS LQDN_EVNT_ACTN_DT,
        LN_LQDN.ACVY_RPTG_PRD,
        LN_LQDN.LN_ACTN_TYP_REF_VAL_CD,
        LN_LQDN.PDSC_RPURD_AM AS LN_PREM_DISC_RPURD_AMT,
        LN_LQDN.ACTL_UPB_AM AS LN_ACTL_UPB_AMT,
        LN_LQDN.TOT_LPTI_AM AS LN_TOT_LNDR_PASS_THRU_INT_AMT,
        LN_LQDN.MD_SRC_SYS_LKUP_OBJ_ID,
        LN_REVW_REFL_SELN_SPST.LN_REVW_SRC_SYS_EVNT_NME_TYP,
        DENSE_RANK() OVER (
            PARTITION BY LN_LQDN.FNM_LN_ID 
            ORDER BY LN_LQDN.BUS_EVNT_TM DESC NULLS LAST
        ) AS SEQ
    FROM ${RS_IDS_SCHEMA_NM}.LN_LQDN AS LN_LQDN
    JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_REFL_SELN_SPST AS LN_REVW_REFL_SELN_SPST
        ON LN_REVW_REFL_SELN_SPST.FNM_LN_ID = LN_LQDN.FNM_LN_ID
    JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST AS LN_REVW_ST_SPST
        ON LN_REVW_ST_SPST.LN_REVW_ID = LN_REVW_REFL_SELN_SPST.LN_REVW_ID
        AND LN_REVW_ST_SPST.FNM_LN_ID = LN_REVW_REFL_SELN_SPST.FNM_LN_ID
        AND LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP = 'IDS'
        AND LN_REVW_REFL_SELN_SPST.EVNT_NME_CD NOT IN ('3001', '3002', '3011', '3030')
    LEFT JOIN (
        SELECT 
            DATA_ENUM_TP, 
            DATA_ENUM_ED, 
            MD_DATA_ENUM_LKUP_OBJ_ID, 
            DATA_ENUM_ATTR_NM
        FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
        WHERE DATA_ENUM_ATTR_NM IN ('ACTN_TI')
    ) AS MD1
        ON MD1.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LQDN.ACTN_TI
    WHERE LN_LQDN.MD_SRC_SYS_LKUP_OBJ_ID IN (7007)
    AND DENSE_RANK() OVER (
        PARTITION BY LN_LQDN.FNM_LN_ID 
        ORDER BY LN_LQDN.BUS_EVNT_TM DESC NULLS LAST
    ) = 1
),
LN_LQDN_RISTMT_REVL AS (
    SELECT 
        LN_LQDN_LTST.*,
        CASE 
            WHEN (
                (DATE(LN_LQDN_LTST.BUS_EVNT_TM) > DATE(LN_LQDN_REVL_MAX_BUS_REC.BUS_EVNT_TM) OR LN_LQDN_REVL_MAX_BUS_REC.BUS_EVNT_TM IS NULL)
                AND (DATE(LN_LQDN_LTST.BUS_EVNT_TM) > DATE(LN_RISTMT_MAX_BUS_REC.BUS_EVNT_TM) OR LN_RISTMT_MAX_BUS_REC.BUS_EVNT_TM IS NULL)
            )
            THEN 'Y' 
        END AS Comp
    FROM LN_LQDN_LTST
    LEFT JOIN LN_LQDN_REVL_MAX_BUS_REC 
        ON LN_LQDN_REVL_MAX_BUS_REC.FNM_LN_ID = LN_LQDN_LTST.FNM_LN_ID
    LEFT JOIN LN_RISTMT_MAX_BUS_REC 
        ON LN_RISTMT_MAX_BUS_REC.FNM_LN_ID = LN_LQDN_LTST.FNM_LN_ID
)

SELECT 
    LN_REVW_ST_SPST_OBJ_ID,
    FNM_LN_ID,
    LN_REVW_ID,
    CAST(BUS_EVNT_TM AS TIMESTAMP) AS BUS_EVNT_TM,
    CAST(ACVY_RPTG_PRD_DT AS TIMESTAMP) AS ACVY_RPTG_PRD_DT,
    BUS_EVNT_REVL_IC,
    LN_ACTN_TYP,
    CAST(LN_ACTN_CD AS NUMERIC) AS LN_ACTN_CD,
    LQDD_UPB_AM,
    CAST(LQDN_EVNT_ACTN_DT AS TIMESTAMP) AS LQDN_EVNT_ACTN_DT,
    ACVY_RPTG_PRD,
    LN_ACTN_TYP_REF_VAL_CD,
    LN_PREM_DISC_RPURD_AMT,
    LN_ACTL_UPB_AMT,
    LN_TOT_LNDR_PASS_THRU_INT_AMT,
    MD_SRC_SYS_LKUP_OBJ_ID,
    LN_REVW_SRC_SYS_EVNT_NME_TYP
FROM LN_LQDN_RISTMT_REVL
WHERE Comp = 'Y';
