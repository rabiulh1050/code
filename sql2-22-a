WITH MD_DATA_ENUM AS (
    SELECT DATA_ENUM_TP, MD_DATA_ENUM_LKUP_OBJ_ID, DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM IN ('STAT_TI', 'FCL_LOSS_RSK_TI', 'LN_DLQY_RSN_TI')
    UNION ALL
    SELECT DATA_ENUM_TP, MD_DATA_ENUM_LKUP_OBJ_ID, DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
    AND DATA_ENUM_TP IN ('AtCashAcquisition', 'AtSecuritization')
),
LN_POS_VW1 AS (
    SELECT
        FNM_LN_ID,
        ACVY_RPTG_PRD,
        BUS_EVNT_TM,
        ACVY_RPTG_PRD_DT,
        LN_DLQ_PRD_CT,
        LN_FCTRD_ACTL_NET_UPB_AM,
        FCTRD_ACTL_TOT_UPB_AM,
        INT_RT,
        LN_PRIN_FRBRN_BAL_AM,
        PRIN_REMD_AM,
        STAT_TI,
        STAT_TI AS LN_STAT_CD,
        FCL_LOSS_RSK_TI,
        LN_DLQY_RSN_TI,
        DENSE_RANK() OVER (PARTITION BY FNM_LN_ID, ACVY_RPTG_PRD ORDER BY ACVY_RPTG_PRD DESC NULLS LAST) AS SEQ
    FROM ${RS_IDS_SCHEMA_NM}.LN_POS
    WHERE MD_SRC_SYS_LKUP_OBJ_ID IN (9999)
),
SELECTED_LN_POS AS (
    SELECT *
    FROM LN_POS_VW1
    WHERE SEQ = 1
)
SELECT 
    LN_REVW_ST_SPST.LN_REVW_ST_SPST_OBJ_ID,
    CNTL_STG.FNM_LN_ID,
    CNTL_STG.LN_REVW_ID,
    LN_POS.ACVY_RPTG_PRD_DT,
    'IDS' AS SRC_SYS_INFC_NME_TYP,
    'AsDelivered' AS LN_REVW_ST_TYP,
    LN_POS.ACVY_RPTG_PRD,
    LN_POS.LN_DLQ_PRD_CT,
    LN_POS.LN_FCTRD_ACTL_NET_UPB_AM,
    LN_POS.FCTRD_ACTL_TOT_UPB_AM,
    LN_POS.INT_RT,
    LN_POS.LN_PRIN_FRBRN_BAL_AM,
    LN_POS.PRIN_REMD_AM,
    MD1.DATA_ENUM_TP AS LN_STAT_TYP,
    LN_POS.STAT_TI AS LN_STAT_CD,
    ${RS_BATCH_ID} AS bch_lqcs_obj_id,
    'N' AS dwh_rec_del_ind,
    USER AS dwh_rec_cren_usr_id,
    current_timestamp AS dwh_rec_cren_dttm,
    USER AS dwh_rec_last_updd_usr_id,
    current_timestamp AS dwh_rec_last_updd_dttm,
    DECODE(CNTL_STG.SRC_SYS_OBJ_ID, 7026, 'LQCS', 7038, 'QAS') AS LN_REVW_SRC_SYS_EVNT_NME_TYP,
    COALESCE(MD3.DATA_ENUM_TP, MD4.DATA_ENUM_TP) AS LN_FCL_LOSS_RSK_TYP,
    COALESCE(LN_POS.FCL_LOSS_RSK_TI, LN_LN.FCL_LOSS_RSK_TI) AS LN_FCL_LOSS_RSK_CD,
    LN_POS.LN_DLQY_RSN_TI AS LN_DLQY_RSN_CD,
    MD5.DATA_ENUM_TP AS LN_DLQY_RSN_TYP
FROM ${RS_CMN_STG_SCHEMA_NM}.LQCS_MDTA_LOAD_CNTL_STG AS CNTL_STG
JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST AS LN_REVW_ST_SPST
    ON LN_REVW_ST_SPST.LN_REVW_ID = CNTL_STG.LN_REVW_ID
    AND LN_REVW_ST_SPST.FNM_LN_ID = CNTL_STG.FNM_LN_ID
    AND LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP = 'IDS'
JOIN SELECTED_LN_POS AS LN_POS
    ON LN_POS.FNM_LN_ID = CNTL_STG.FNM_LN_ID
LEFT JOIN ${RS_IDS_SCHEMA_NM}.LN_LN AS LN_LN
    ON LN_LN.FNM_LN_ID = LN_POS.FNM_LN_ID
    AND LN_LN.AQSN_ACVY_RPTG_PRD_DT = LN_POS.ACVY_RPTG_PRD_DT
    AND LN_LN.MD_SRC_SYS_LKUP_OBJ_ID = 9999
LEFT JOIN MD_DATA_ENUM AS MD1
    ON MD1.MD_DATA_ENUM_LKUP_OBJ_ID = LN_POS.STAT_TI
    AND MD1.DATA_ENUM_ATTR_NM = 'STAT_TI'
LEFT JOIN MD_DATA_ENUM AS MD2
    ON MD2.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN.FINS_LFC_TI
    AND MD2.DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
LEFT JOIN MD_DATA_ENUM AS MD3
    ON MD3.MD_DATA_ENUM_LKUP_OBJ_ID = LN_POS.FCL_LOSS_RSK_TI
    AND MD3.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
LEFT JOIN MD_DATA_ENUM AS MD4
    ON MD4.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN.FCL_LOSS_RSK_TI
    AND MD4.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
LEFT JOIN MD_DATA_ENUM AS MD5
    ON MD5.MD_DATA_ENUM_LKUP_OBJ_ID = LN_POS.LN_DLQY_RSN_TI
    AND MD5.DATA_ENUM_ATTR_NM = 'LN_DLQY_RSN_TI';
