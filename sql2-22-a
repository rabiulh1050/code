WITH MD_DATA_ENUM AS (
    SELECT 
        DATA_ENUM_TP,
        MD_DATA_ENUM_LKUP_OBJ_ID,
        DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM IN ('STAT_TI', 'FCL_LOSS_RSK_TI', 'LN_DLQY_RSN_TI')
    UNION
    SELECT 
        DATA_ENUM_TP,
        MD_DATA_ENUM_LKUP_OBJ_ID,
        DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE 
        DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
        AND DATA_ENUM_TP IN ('AtCashAcquisition', 'AtSecuritization')
),
LN_POS_VW1 AS (
    SELECT 
        LN_POS1.FNM_LN_ID,
        LN_POS1.ACVY_RPTG_PRD,
        LN_POS1.BUS_EVNT_TM,
        LN_POS1.ACVY_RPTG_PRD_DT,
        LN_POS1.LN_DLQ_PRD_CT,
        LN_POS1.LN_FCTRD_ACTL_NET_UPB_AM,
        LN_POS1.FCTRD_ACTL_TOT_UPB_AM,
        LN_POS1.INT_RT,
        LN_POS1.LN_PRIN_FRBRN_BAL_AM,
        LN_POS1.PRIN_REMD_AM,
        LN_POS1.STAT_TI,
        LN_POS1.LN_STAT_CD,
        LN_POS1.FCL_LOSS_RSK_TI,
        LN_POS1.LN_DLQY_RSN_TI
    FROM (
        SELECT 
            FNM_LN_ID,
            ACVY_RPTG_PRD,
            BUS_EVNT_TM,
            ACVY_RPTG_PRD_DT,
            LN_DLQ_PRD_CT,
            LN_FCTRD_ACTL_NET_UPB_AM,
            FCTRD_ACTL_TOT_UPB_AM,
            INT_RT,
            LN_PRIN_FRBRN_BAL_AM,
            PRIN_REMD_AM,
            STAT_TI,
            STAT_TI AS LN_STAT_CD,
            FCL_LOSS_RSK_TI,
            LN_DLQY_RSN_TI,
            DENSE_RANK() OVER (
                PARTITION BY FNM_LN_ID, ACVY_RPTG_PRD
                ORDER BY ACVY_RPTG_PRD DESC NULLS LAST
            ) AS SEQ
        FROM ${RS_IDS_SCHEMA_NM}.LN_POS
        WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
    ) AS LN_POS1
    WHERE LN_POS1.SEQ = 1
),
LN_LN_VW1 AS (
    SELECT 
        FNM_LN_ID,
        AQSN_ACVY_RPTG_PRD_DT,
        FINS_LFC_TI,
        FCL_LOSS_RSK_TI
    FROM ${RS_IDS_SCHEMA_NM}.LN_LN
    WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
)
SELECT 
    LN_REV_POS_SPST.LN_REVW_ST_SPST_OBJ_ID,
    LN_REV_POS_SPST.FNM_LN_ID,
    LN_REV_POS_SPST.LN_REVW_ID,
    LN_REV_POS_SPST.ACVY_RPTG_PRD_DT,
    LN_REV_POS_SPST.SRC_SYS_INFC_NME_TYP,
    LN_REV_POS_SPST.LN_REVW_ST_TYP,
    LN_REV_POS_SPST.ACVY_RPTG_PRD,
    LN_REV_POS_SPST.LN_DLQ_PRD_CT,
    LN_REV_POS_SPST.LN_FCTRD_ACTL_NET_UPB_AM,
    LN_REV_POS_SPST.FCTRD_ACTL_TOT_UPB_AM,
    LN_REV_POS_SPST.INT_RT,
    LN_REV_POS_SPST.LN_PRIN_FRBRN_BAL_AM,
    LN_REV_POS_SPST.PRIN_REMD_AM,
    LN_REV_POS_SPST.LN_STAT_TYP,
    LN_REV_POS_SPST.LN_STAT_CD,
    ${RS_BATCH_ID} AS bch_lqcs_obj_id,
    'N' AS dwh_rec_del_ind,
    USER AS dwh_rec_cren_usr_id,
    CURRENT_TIMESTAMP AS dwh_rec_cren_dttm,
    USER AS dwh_rec_last_updd_usr_id,
    CURRENT_TIMESTAMP AS dwh_rec_last_updd_dttm,
    LN_REV_POS_SPST.LN_REVW_SRC_SYS_EVNT_NME_TYP,
    LN_REV_POS_SPST.LN_DLQY_RSN_TYP,
    LN_REV_POS_SPST.LN_DLQY_RSN_CD,
    LN_REV_POS_SPST.LN_FCL_LOSS_RSK_TYP,
    LN_REV_POS_SPST.LN_FCL_LOSS_RSK_CD
FROM (
    SELECT 
        LN_REVW_ST_SPST.LN_REVW_ST_SPST_OBJ_ID,
        CNTL_STG.FNM_LN_ID,
        CNTL_STG.LN_REVW_ID,
        LN_POS_VW1.ACVY_RPTG_PRD_DT,
        'IDS' AS SRC_SYS_INFC_NME_TYP,
        'AsDelivered' AS LN_REVW_ST_TYP,
        LN_POS_VW1.ACVY_RPTG_PRD,
        LN_POS_VW1.LN_DLQ_PRD_CT,
        LN_POS_VW1.LN_FCTRD_ACTL_NET_UPB_AM,
        LN_POS_VW1.FCTRD_ACTL_TOT_UPB_AM,
        LN_POS_VW1.INT_RT,
        LN_POS_VW1.LN_PRIN_FRBRN_BAL_AM,
        LN_POS_VW1.PRIN_REMD_AM,
        MD1.DATA_ENUM_TP AS LN_STAT_TYP,
        LN_POS_VW1.STAT_TI AS LN_STAT_CD,
        DECODE(CNTL_STG.SRC_SYS_OBJ_ID, 7026, 'LQCS', 7038, 'QAS') AS LN_REVW_SRC_SYS_EVNT_NME_TYP,
        COALESCE(MD3.DATA_ENUM_TP, MD4.DATA_ENUM_TP) AS LN_FCL_LOSS_RSK_TYP,
        COALESCE(LN_POS_VW1.FCL_LOSS_RSK_TI, LN_LN_VW1.FCL_LOSS_RSK_TI) AS LN_FCL_LOSS_RSK_CD,
        LN_POS_VW1.LN_DLQY_RSN_TI AS LN_DLQY_RSN_CD,
        MD5.DATA_ENUM_TP AS LN_DLQY_RSN_TYP
    FROM ${RS_CMN_STG_SCHEMA_NM}.LQCS_MDTA_LOAD_CNTL_STG AS CNTL_STG
    JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST AS LN_REVW_ST_SPST 
        ON LN_REVW_ST_SPST.LN_REVW_ID = CNTL_STG.LN_REVW_ID
        AND LN_REVW_ST_SPST.FNM_LN_ID = CNTL_STG.FNM_LN_ID
        AND LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP = 'IDS'
    JOIN LN_POS_VW1 
        ON LN_POS_VW1.FNM_LN_ID = CNTL_STG.FNM_LN_ID
    LEFT JOIN LN_LN_VW1 
        ON LN_LN_VW1.FNM_LN_ID = LN_POS_VW1.FNM_LN_ID
        AND LN_LN_VW1.AQSN_ACVY_RPTG_PRD_DT = LN_POS_VW1.ACVY_RPTG_PRD_DT
    LEFT JOIN MD_DATA_ENUM AS MD1 
        ON MD1.MD_DATA_ENUM_LKUP_OBJ_ID = LN_POS_VW1.STAT_TI
        AND MD1.DATA_ENUM_ATTR_NM = 'STAT_TI'
    LEFT JOIN MD_DATA_ENUM AS MD2 
        ON MD2.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN_VW1.FINS_LFC_TI
        AND MD2.DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
    LEFT JOIN MD_DATA_ENUM AS MD3 
        ON MD3.MD_DATA_ENUM_LKUP_OBJ_ID = LN_POS_VW1.FCL_LOSS_RSK_TI
        AND MD3.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
    LEFT JOIN MD_DATA_ENUM AS MD4 
        ON MD4.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN_VW1.FCL_LOSS_RSK_TI
        AND MD4.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
    LEFT JOIN MD_DATA_ENUM AS MD5 
        ON MD5.MD_DATA_ENUM_LKUP_OBJ_ID = LN_POS_VW1.LN_DLQY_RSN_TI
        AND MD5.DATA_ENUM_ATTR_NM = 'LN_DLQY_RSN_TI'
) LN_REV_POS_SPST;
