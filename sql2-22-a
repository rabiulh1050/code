WITH MD_DATA_ENUM AS (
    SELECT DATA_ENUM_TP, MD_DATA_ENUM_LKUP_OBJ_ID, DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM in ('STAT_TI','FCL_LOSS_RSK_TI','LN_DLQY_RSN_TI', 'FINS_LFC_TI')
      AND (DATA_ENUM_TP IN ('AtCashAcquisition', 'AtSecuritization') OR DATA_ENUM_TP IS NOT NULL)
),
LN_POS_VW1 AS (
    SELECT FNM_LN_ID, ACVY_RPTG_PRD, BUS_EVNT_TM, ACVY_RPTG_PRD_DT, LN_DLQ_PRD_CT,
           LN_FCTRD_ACTL_NET_UPB_AM, FCTRD_ACTL_TOT_UPB_AM, INT_RT, LN_PRIN_FRBRN_BAL_AM,
           PRIN_REMD_AM, STAT_TI, FCL_LOSS_RSK_TI, LN_DLQY_RSN_TI,
           ROW_NUMBER() OVER (PARTITION BY FNM_LN_ID ORDER BY ACVY_RPTG_PRD DESC) AS SEQ
    FROM ${RS_IDS_SCHEMA_NM}.LN_POS
    WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
      AND SEQ = 1
),
FINAL_DATA AS (
    SELECT ...
    FROM ${RS_CMN_STG_SCHEMA_NM}.LQCS_MDTA_LOAD_CNTL_STG AS CNTL_STG
    JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST ON LN_REVW_ST_SPST.LN_REVW_ID = CNTL_STG.LN_REVW_ID
                                                       AND LN_REVW_ST_SPST.FNM_LN_ID = CNTL_STG.FNM_LN_ID
                                                       AND LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP = 'IDS'
    JOIN LN_POS_VW1 ON LN_POS_VW1.FNM_LN_ID = CNTL_STG.FNM_LN_ID
    LEFT JOIN ${RS_IDS_SCHEMA_NM}.LN_LN ON LN_LN.FNM_LN_ID = LN_POS_VW1.FNM_LN_ID
                                       AND LN_LN.AQSN_ACVY_RPTG_PRD_DT = LN_POS_VW1.ACVY_RPTG_PRD_DT
                                       AND LN_LN.MD_SRC_SYS_LKUP_OBJ_ID = 9999
    LEFT JOIN MD_DATA_ENUM MD1 ON MD1.MD_DATA_ENUM_LKUP_OBJ_ID = LN_POS_VW1.STAT_TI
                                AND MD1.DATA_ENUM_ATTR_NM = 'STAT_TI'
    LEFT JOIN MD_DATA_ENUM MD2 ON MD2.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN.FINS_LFC_TI
                                AND MD2.DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
    -- Add other necessary joins
)
SELECT *
FROM FINAL_DATA;
