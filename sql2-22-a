WITH MD_DATA_ENUM AS (
    SELECT 
        DATA_ENUM_TP,
        MD_DATA_ENUM_LKUP_OBJ_ID,
        DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM IN ('LN_REPN_WRTY_RELF_TI', 'LN_REPN_WRTY_RELF_STAT_RSN_TI', 'LN_REPN_WRTY_RELF_STAT_TI')
)
SELECT 
    LN_REPN_WRTY_RELF.LN_REVW_ST_SPST_OBJ_ID,
    LN_REPN_WRTY_RELF.FNM_LN_ID,
    LN_REPN_WRTY_RELF.LN_REVW_ID,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_TYP,
    LN_REPN_WRTY_RELF.SRC_SYS_INFC_NME_TYP,
    LN_REPN_WRTY_RELF.LN_REVW_ST_TYP,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_TI,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_ACHVD_DT,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_ELIG_IC,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_INELGB_DT,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_STAT_RSN_TYP,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_STAT_RSN_TI,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_STAT_TYP,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_STAT_TI,
    LN_REPN_WRTY_RELF.LN_REPN_WRTY_RELF_TRGT_DT,
    ${RS_BATCH_ID} AS BATCH_OBJ_ID,
    'N' AS DWH_REC_DEL_IND,
    USER AS DWH_REC_CREN_USR_ID,
    CURRENT_TIMESTAMP AS DWH_REC_CREN_DTTM,
    USER AS DWH_REC_CREN_USR_ID,
    CURRENT_TIMESTAMP AS DWH_REC_LAST_UPDD_DTTM,
    LN_REPN_WRTY_RELF.LN_REVW_SRC_SYS_EVNT_NME_TYP
FROM (
    WITH MD_DATA_ENUM AS (
        SELECT 
            DATA_ENUM_TP,
            MD_DATA_ENUM_LKUP_OBJ_ID,
            DATA_ENUM_ATTR_NM
        FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
        WHERE DATA_ENUM_ATTR_NM IN ('LN_REPN_WRTY_RELF_TI', 'LN_REPN_WRTY_RELF_STAT_RSN_TI', 'LN_REPN_WRTY_RELF_STAT_TI')
    )
    SELECT 
        STSPST_REP.LN_REVW_ST_SPST_OBJ_ID,
        STSPST_REP.FNM_LN_ID,
        STSPST_REP.LN_REVW_ID,
        COALESCE(LN_REPN_WRTY_RELF_TI.DATA_ENUM_TP, 'EnumNotAvailable') AS LN_REPN_WRTY_RELF_TYP,
        CASE 
            WHEN STSPST_REP.MD_SRC_SYS_LKUP_OBJ_ID = 7026 AND STSPST_REP.LN_REVW_ID ~ '.*[a-zA-Z].*' THEN 'LQCS'
            WHEN STSPST_REP.MD_SRC_SYS_LKUP_OBJ_ID = 7038 THEN 'QAS'
            WHEN STSPST_REP.LN_REVW_ID ~ '.*^[^a-zA-Z].*' THEN 'QAS'
            ELSE 'IDS'
        END AS SRC_SYS_INFC_NME_TYP,
        CASE 
            WHEN STSPST_REP.SRC_SYS_INFC_NME_TYP IN ('LQCS', 'QAS') THEN 'AsReviewed'
            ELSE 'AsDelivered'
        END AS LN_REVW_ST_TYP,
        STSPST_REP.LN_REPN_WRTY_RELF_TI,
        STSPST_REP.LN_REPN_WRTY_RELF_ACHVD_DT,
        STSPST_REP.LN_REPN_WRTY_RELF_ELIG_IC,
        STSPST_REP.LN_REPN_WRTY_RELF_INELGB_DT,
        LN_REPN_WRTY_RELF_STAT_RSN_TI.DATA_ENUM_TP AS LN_REPN_WRTY_RELF_STAT_RSN_TYP,
        STSPST_REP.LN_REPN_WRTY_RELF_STAT_RSN_TI,
        LN_REPN_WRTY_RELF_STAT_TI.DATA_ENUM_TP AS LN_REPN_WRTY_RELF_STAT_TYP,
        STSPST_REP.LN_REPN_WRTY_RELF_STAT_TI,
        STSPST_REP.LN_REPN_WRTY_RELF_TRGT_DT,
        DECODE(LQCS_MDTA_LOAD_CNTL_STG.SRC_SYS_OBJ_ID, 7026, 'LQCS', 7038, 'QAS') AS LN_REVW_SRC_SYS_EVNT_NME_TYP
    FROM 
        ${RS_CMN_STG_SCHEMA_NM}.LQCS_MDTA_LOAD_CNTL_STG LQCS_MDTA_LOAD_CNTL_STG
    JOIN (
        SELECT 
            LN_REVW_ST_SPST.LN_REVW_ST_SPST_OBJ_ID,
            LN_REVW_ST_SPST.FNM_LN_ID,
            LN_REVW_ST_SPST.LN_REVW_ID,
            LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP,
            REPNWRTY.LN_REPN_WRTY_RELF_TI,
            REPNWRTY.LN_REPN_WRTY_RELF_ACHVD_DT,
            REPNWRTY.LN_REPN_WRTY_RELF_ELIG_IC,
            REPNWRTY.LN_REPN_WRTY_RELF_INELGB_DT,
            REPNWRTY.LN_REPN_WRTY_RELF_STAT_RSN_TI,
            REPNWRTY.LN_REPN_WRTY_RELF_STAT_TI,
            REPNWRTY.MD_SRC_SYS_LKUP_OBJ_ID,
            REPNWRTY.LN_REPN_WRTY_RELF_TRGT_DT
        FROM
            ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST LN_REVW_ST_SPST
        JOIN ${RS_IDS_SCHEMA_NM}.LN_REPN_WRTY_RELF REPNWRTY
            ON LN_REVW_ST_SPST.FNM_LN_ID = REPNWRTY.FNM_LN_ID
            AND LN_REVW_ST_SPST.LN_REVW_ID = REPNWRTY.LN_REVW_ID
            AND DECODE(LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP, 'LQCS', 7026, 'QAS', 7038, NULL) = REPNWRTY.MD_SRC_SYS_LKUP_OBJ_ID
        UNION
        SELECT 
            LN_REVW_ST_SPST.LN_REVW_ST_SPST_OBJ_ID,
            LN_REVW_ST_SPST.FNM_LN_ID,
            LN_REVW_ST_SPST.LN_REVW_ID,
            LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP,
            REPNWRTY1.LN_REPN_WRTY_RELF_TI,
            REPNWRTY1.LN_REPN_WRTY_RELF_ACHVD_DT,
            REPNWRTY1.LN_REPN_WRTY_RELF_ELIG_IC,
            REPNWRTY1.LN_REPN_WRTY_RELF_INELGB_DT,
            REPNWRTY1.LN_REPN_WRTY_RELF_STAT_RSN_TI,
            REPNWRTY1.LN_REPN_WRTY_RELF_STAT_TI,
            REPNWRTY1.MD_SRC_SYS_LKUP_OBJ_ID,
            REPNWRTY1.LN_REPN_WRTY_RELF_TRGT_DT
        FROM
            ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST LN_REVW_ST_SPST
        JOIN ${RS_IDS_SCHEMA_NM}.LN_REPN_WRTY_RELF REPNWRTY1
            ON LN_REVW_ST_SPST.FNM_LN_ID = REPNWRTY1.FNM_LN_ID
            AND DECODE(LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP, 'IDS', 9999, NULL) = REPNWRTY1.MD_SRC_SYS_LKUP_OBJ_ID
    ) STSPST_REP
    ON STSPST_REP.LN_REVW_ID = LQCS_MDTA_LOAD_CNTL_STG.LN_REVW_ID 
    AND STSPST_REP.FNM_LN_ID = LQCS_MDTA_LOAD_CNTL_STG.FNM_LN_ID 
    LEFT JOIN MD_DATA_ENUM LN_REPN_WRTY_RELF_TI 
        ON LN_REPN_WRTY_RELF_TI.MD_DATA_ENUM_LKUP_OBJ_ID = STSPST_REP.LN_REPN_WRTY_RELF_TI
        AND LN_REPN_WRTY_RELF_TI.DATA_ENUM_ATTR_NM = 'LN_REPN_WRTY_RELF_TI'
    LEFT JOIN MD_DATA_ENUM LN_REPN_WRTY_RELF_STAT_RSN_TI 
        ON LN_REPN_WRTY_RELF_STAT_RSN_TI.MD_DATA_ENUM_LKUP_OBJ_ID = STSPST_REP.LN_REPN_WRTY_RELF_STAT_RSN_TI
        AND LN_REPN_WRTY_RELF_STAT_RSN_TI.DATA_ENUM_ATTR_NM = 'LN_REPN_WRTY_RELF_STAT_RSN_TI'
    LEFT JOIN MD_DATA_ENUM LN_REPN_WRTY_RELF_STAT_TI 
        ON LN_REPN_WRTY_RELF_STAT_TI.MD_DATA_ENUM_LKUP_OBJ_ID = STSPST_REP.LN_REPN_WRTY_RELF_STAT_TI
        AND LN_REPN_WRTY_RELF_STAT_TI.DATA_ENUM_ATTR_NM = 'LN_REPN_WRTY_RELF_STAT_TI'
    UNION
    SELECT
        NULL AS LN_REVW_ST_SPST_OBJ_ID,
        SRC.FNM_LN_ID,
        SRC.LN_REVW_ID,
        COALESCE(LN_REPN_WRTY_RELF_TI.DATA_ENUM_TP, 'EnumNotAvailable') AS LN_REPN_WRTY_RELF_TYP,
        CASE 
            WHEN SRC.MD_SRC_SYS_LKUP_OBJ_ID = 7026 AND SRC.LN_REVW_ID ~ '.*[a-zA-Z].*' THEN 'LQCS'
            ELSE 'QAS'
        END AS SRC_SYS_INFC_NME_TYP,
        DECODE(SRC.MD_SRC_SYS_LKUP_OBJ_ID, 7026, 'AsReviewed') AS LN_REVW_ST_TYP,
        SRC.LN_REPN_WRTY_RELF_TI,
        SRC.LN_REPN_WRTY_RELF_ACHVD_DT,
        SRC.LN_REPN_WRTY_RELF_ELIG_IC,
        SRC.LN_REPN_WRTY_RELF_INELGB_DT,
        LN_REPN_WRTY_RELF_STAT_RSN_TI.DATA_ENUM_TP AS LN_REPN_WRTY_RELF_STAT_RSN_TYP,
        SRC.LN_REPN_WRTY_RELF_STAT_RSN_TI,
        LN_REPN_WRTY_RELF_STAT_TI.DATA_ENUM_TP AS LN_REPN_WRTY_RELF_STAT_TYP,
        SRC.LN_REPN_WRTY_RELF_STAT_TI,
        SRC.LN_REPN_WRTY_RELF_TRGT_DT,
        DECODE(STG.SRC_SYS_OBJ_ID, 7026, 'LQCS', 7038, 'QAS') AS LN_REVW_SRC_SYS_EVNT_NME_TYP
    FROM
        ${RS_CMN_STG_SCHEMA_NM}.LQCS_MDTA_LOAD_CNTL_STG STG
    JOIN ${RS_IDS_SCHEMA_NM}.LN_REPN_WRTY_RELF SRC
        ON STG.FNM_LN_ID = SRC.FNM_LN_ID
        AND STG.LN_REVW_ID = SRC.LN_REVW_ID
        AND SRC.MD_SRC_SYS_LKUP_OBJ_ID = 7026
        AND STG.SRC_SYS_OBJ_ID = 7026
    LEFT JOIN (
        SELECT 
            FNM_LN_ID,
            LN_REVW_ID,
            SRC_SYS_INFC_NME_TYP,
            LN_REVW_ST_SPST_OBJ_ID
        FROM ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST
        WHERE SRC_SYS_INFC_NME_TYP = 'LQCS'
    ) STSPST
        ON STSPST.FNM_LN_ID = SRC.FNM_LN_ID
        AND STSPST.LN_REVW_ID = SRC.LN_REVW_ID
        AND SRC.MD_SRC_SYS_LKUP_OBJ_ID = 7026
        AND DECODE(STSPST.SRC_SYS_INFC_NME_TYP, 'LQCS', 7026, NULL) = SRC.MD_SRC_SYS_LKUP_OBJ_ID
    LEFT JOIN MD_DATA_ENUM LN_REPN_WRTY_RELF_TI 
        ON LN_REPN_WRTY_RELF_TI.MD_DATA_ENUM_LKUP_OBJ_ID = SRC.LN_REPN_WRTY_RELF_TI
        AND LN_REPN_WRTY_RELF_TI.DATA_ENUM_ATTR_NM = 'LN_REPN_WRTY_RELF_TI'
    LEFT JOIN MD_DATA_ENUM LN_REPN_WRTY_RELF_STAT_RSN_TI 
        ON LN_REPN_WRTY_RELF_STAT_RSN_TI.MD_DATA_ENUM_LKUP_OBJ_ID = SRC.LN_REPN_WRTY_RELF_STAT_RSN_TI
        AND LN_REPN_WRTY_RELF_STAT_RSN_TI.DATA_ENUM_ATTR_NM = 'LN_REPN_WRTY_RELF_STAT_RSN_TI'
    LEFT JOIN MD_DATA_ENUM LN_REPN_WRTY_RELF_STAT_TI 
        ON LN_REPN_WRTY_RELF_STAT_TI.MD_DATA_ENUM_LKUP_OBJ_ID = SRC.LN_REPN_WRTY_RELF_STAT_TI
        AND LN_REPN_WRTY_RELF_STAT_TI.DATA_ENUM_ATTR_NM = 'LN_REPN_WRTY_RELF_STAT_TI'
    WHERE STSPST.LN_REVW_ST_SPST_OBJ_ID IS NULL
) LN_REPN_WRTY_RELF;
