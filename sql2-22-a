WITH MD_DATA_ENUM AS (
    SELECT DATA_ENUM_TP, MD_DATA_ENUM_LKUP_OBJ_ID, DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM IN ('STAT_TI', 'FCL_LOSS_RSK_TI', 'LN_DLQY_RSN_TI', 'FINS_LFC_TI')
      AND (DATA_ENUM_TP IN ('AtCashAcquisition', 'AtSecuritization') OR DATA_ENUM_TP IS NOT NULL)
),
LN_POS_VW1 AS (
    SELECT FNM_LN_ID, ACVY_RPTG_PRD_DT, LN_DLQ_PRD_CT, LN_FCTRD_ACTL_NET_UPB_AM, 
           FCTRD_ACTL_TOT_UPB_AM, INT_RT, LN_PRIN_FRBRN_BAL_AM, PRIN_REMD_AM, STAT_TI, 
           LN_STAT_CD, FCL_LOSS_RSK_TI, LN_DLQY_RSN_TI,
           ROW_NUMBER() OVER (PARTITION BY FNM_LN_ID ORDER BY ACVY_RPTG_PRD DESC) AS SEQ
    FROM ${RS_IDS_SCHEMA_NM}.LN_POS
    WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
),
FILTERED_LN_POS_VW1 AS (
    SELECT *
    FROM LN_POS_VW1
    WHERE SEQ = 1
),
FINAL_DATA AS (
    SELECT 
        LN_REVW_ST_SPST.LN_REVW_ST_SPST_OBJ_ID,
        CNTL_STG.FNM_LN_ID,
        CNTL_STG.LN_REVW_ID,
        FILTERED_LN_POS_VW1.ACVY_RPTG_PRD_DT,
        'IDS' AS SRC_SYS_INFC_NME_TYP,
        'AsDelivered' AS LN_REVW_ST_TYP,
        FILTERED_LN_POS_VW1.ACVY_RPTG_PRD,
        FILTERED_LN_POS_VW1.LN_DLQ_PRD_CT,
        FILTERED_LN_POS_VW1.LN_FCTRD_ACTL_NET_UPB_AM,
        FILTERED_LN_POS_VW1.FCTRD_ACTL_TOT_UPB_AM,
        FILTERED_LN_POS_VW1.INT_RT,
        FILTERED_LN_POS_VW1.LN_PRIN_FRBRN_BAL_AM,
        FILTERED_LN_POS_VW1.PRIN_REMD_AM,
        DECODE (CNTL_STG.SRC_SYS_OBJ_ID, 7026, 'LQCS', 7038, 'QAS') AS LN_REVW_SRC_SYS_EVNT_NME_TYP,
        MD1.DATA_ENUM_TP AS LN_STAT_TYP,
        FILTERED_LN_POS_VW1.STAT_TI AS LN_STAT_CD,
        CASE 
            WHEN MD3.DATA_ENUM_TP IS NOT NULL THEN MD3.DATA_ENUM_TP
            ELSE MD4.DATA_ENUM_TP 
        END AS LN_FCL_LOSS_RSK_TYP,
        CASE 
            WHEN FILTERED_LN_POS_VW1.FCL_LOSS_RSK_TI IS NOT NULL THEN FILTERED_LN_POS_VW1.FCL_LOSS_RSK_TI
            ELSE LN_LN_VW1.FCL_LOSS_RSK_TI 
        END AS LN_FCL_LOSS_RSK_CD,
        MD5.DATA_ENUM_TP AS LN_DLQY_RSN_TYP,
        FILTERED_LN_POS_VW1.LN_DLQY_RSN_TI AS LN_DLQY_RSN_CD
    FROM ${RS_CMN_STG_SCHEMA_NM}.LQCS_MDTA_LOAD_CNTL_STG AS CNTL_STG
    JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST ON 
        LN_REVW_ST_SPST.LN_REVW_ID = CNTL_STG.LN_REVW_ID AND 
        LN_REVW_ST_SPST.FNM_LN_ID = CNTL_STG.FNM_LN_ID AND 
        LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP = 'IDS'
    JOIN FILTERED_LN_POS_VW1 ON 
        FILTERED_LN_POS_VW1.FNM_LN_ID = CNTL_STG.FNM_LN_ID
    LEFT JOIN ${RS_IDS_SCHEMA_NM}.LN_LN LN_LN_VW1 ON 
        LN_LN_VW1.FNM_LN_ID = FILTERED_LN_POS_VW1.FNM_LN_ID AND 
        LN_LN_VW1.AQSN_ACVY_RPTG_PRD_DT = FILTERED_LN_POS_VW1.ACVY_RPTG_PRD_DT AND 
        LN_LN_VW1.MD_SRC_SYS_LKUP_OBJ_ID = 9999
    LEFT JOIN MD_DATA_ENUM MD1 ON 
        MD1.MD_DATA_ENUM_LKUP_OBJ_ID = FILTERED_LN_POS_VW1.STAT_TI AND 
        MD1.DATA_ENUM_ATTR_NM = 'STAT_TI'
    LEFT JOIN MD_DATA_ENUM MD3 ON 
        MD3.MD_DATA_ENUM_LKUP_OBJ_ID = FILTERED_LN_POS_VW1.FCL_LOSS_RSK_TI AND 
        MD3.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
    LEFT JOIN MD_DATA_ENUM MD4 ON 
        MD4.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN_VW1.FCL_LOSS_RSK_TI AND 
        MD4.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
    LEFT JOIN MD_DATA_ENUM MD5 ON 
        MD5.MD_DATA_ENUM_LKUP_OBJ_ID = FILTERED_LN_POS_VW1.LN_DLQY_RSN_TI AND 
        MD5.DATA_ENUM_ATTR_NM = 'LN_DLQY_RSN_TI'
)
SELECT 
    LN_REVW_ST_SPST_OBJ_ID,
    FNM_LN_ID,
    LN_REVW_ID,
    ACVY_RPTG_PRD_DT,
    SRC_SYS_INFC_NME_TYP,
    LN_REVW_ST_TYP,
    ACVY_RPTG_PRD,
    LN_DLQ_PRD_CT,
    LN_FCTRD_ACTL_NET_UPB_AM,
    FCTRD_ACTL_TOT_UPB_AM,
    INT_RT,
    LN_PRIN_FRBRN_BAL_AM,
    PRIN_REMD_AM,
    LN_REVW_SRC_SYS_EVNT_NME_TYP,
    LN_STAT_TYP,
    LN_STAT_CD,
    LN_FCL_LOSS_RSK_TYP,
    LN_FCL_LOSS_RSK_CD,
    LN_DLQY_RSN_TYP,
    LN_DLQY_RSN_CD,
    ${RS_BATCH_ID} as bch_lqcs_obj_id,
    'N' as dwh_rec_del_ind,
    USER as dwh_rec_cren_usr_id,
    current_timestamp as dwh_rec_cren_dttm,
    USER as dwh_rec_last_updd_usr_id,
    current_timestamp as dwh_rec_last_updd_dttm
FROM FINAL_DATA;
