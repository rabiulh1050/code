WITH MD_DATA_ENUM AS (
    SELECT 
        DATA_ENUM_TP, 
        MD_DATA_ENUM_LKUP_OBJ_ID, 
        DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM IN ('STAT_TI', 'FCL_LOSS_RSK_TI', 'LN_DLQY_RSN_TI')
    UNION
    SELECT 
        DATA_ENUM_TP, 
        MD_DATA_ENUM_LKUP_OBJ_ID, 
        DATA_ENUM_ATTR_NM
    FROM ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    WHERE DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
        AND DATA_ENUM_TP IN ('AtCashAcquisition', 'AtSecuritization')
),
LN_POS_VW1 AS (
    SELECT 
        FNM_LN_ID,
        ACVY_RPTG_PRD,
        BUS_EVNT_TM,
        ACVY_RPTG_PRD_DT,
        LN_DLQ_PRD_CT,
        LN_FCTRD_ACTL_NET_UPB_AM,
        FCTRD_ACTL_TOT_UPB_AM,
        INT_RT,
        LN_PRIN_FRBRN_BAL_AM,
        PRIN_REMD_AM,
        STAT_TI,
        STAT_TI AS LN_STAT_CD,
        FCL_LOSS_RSK_TI,
        LN_DLQY_RSN_TI,
        DENSE_RANK() OVER (
            PARTITION BY FNM_LN_ID, ACVY_RPTG_PRD 
            ORDER BY ACVY_RPTG_PRD DESC NULLS LAST
        ) AS SEQ
    FROM ${RS_IDS_SCHEMA_NM}.LN_POS
    WHERE MD_SRC_SYS_LKUP_OBJ_ID = 9999
),
FILTERED_LN_POS AS (
    SELECT 
        FNM_LN_ID,
        ACVY_RPTG_PRD,
        BUS_EVNT_TM,
        ACVY_RPTG_PRD_DT,
        LN_DLQ_PRD_CT,
        LN_FCTRD_ACTL_NET_UPB_AM,
        FCTRD_ACTL_TOT_UPB_AM,
        INT_RT,
        LN_PRIN_FRBRN_BAL_AM,
        PRIN_REMD_AM,
        STAT_TI,
        LN_STAT_CD,
        FCL_LOSS_RSK_TI,
        LN_DLQY_RSN_TI
    FROM LN_POS_VW1
    WHERE SEQ = 1
),
JOINED_LN_POS AS (
    SELECT 
        LN_REVW_ST_SPST.LN_REVW_ST_SPST_OBJ_ID,
        CNTL_STG.FNM_LN_ID,
        CNTL_STG.LN_REVW_ID,
        FILTERED_LN_POS.ACVY_RPTG_PRD_DT,
        'IDS' AS SRC_SYS_INFC_NME_TYP,
        'AsDelivered' AS LN_REVW_ST_TYP,
        FILTERED_LN_POS.ACVY_RPTG_PRD,
        FILTERED_LN_POS.LN_DLQ_PRD_CT,
        FILTERED_LN_POS.LN_FCTRD_ACTL_NET_UPB_AM,
        FILTERED_LN_POS.FCTRD_ACTL_TOT_UPB_AM,
        FILTERED_LN_POS.INT_RT,
        FILTERED_LN_POS.LN_PRIN_FRBRN_BAL_AM,
        FILTERED_LN_POS.PRIN_REMD_AM,
        MD1.DATA_ENUM_TP AS LN_STAT_TYP,
        FILTERED_LN_POS.STAT_TI AS LN_STAT_CD,
        DECODE(CNTL_STG.SRC_SYS_OBJ_ID, 7026, 'LQCS', 7038, 'QAS') AS LN_REVW_SRC_SYS_EVNT_NME_TYP,
        COALESCE(MD3.DATA_ENUM_TP, MD4.DATA_ENUM_TP) AS LN_FCL_LOSS_RSK_TYP,
        COALESCE(FILTERED_LN_POS.FCL_LOSS_RSK_TI, LN_LN_VW1.FCL_LOSS_RSK_TI) AS LN_FCL_LOSS_RSK_CD,
        FILTERED_LN_POS.LN_DLQY_RSN_TI AS LN_DLQY_RSN_CD,
        MD5.DATA_ENUM_TP AS LN_DLQY_RSN_TYP
    FROM ${RS_CMN_STG_SCHEMA_NM}.LQCS_MDTA_LOAD_CNTL_STG CNTL_STG
    JOIN ${RS_CONV_TGT_DIM_SCHEMA_NM}.LN_REVW_ST_SPST LN_REVW_ST_SPST 
        ON LN_REVW_ST_SPST.LN_REVW_ID = CNTL_STG.LN_REVW_ID
        AND LN_REVW_ST_SPST.FNM_LN_ID = CNTL_STG.FNM_LN_ID
        AND LN_REVW_ST_SPST.SRC_SYS_INFC_NME_TYP = 'IDS'
    JOIN FILTERED_LN_POS
        ON FILTERED_LN_POS.FNM_LN_ID = CNTL_STG.FNM_LN_ID
    LEFT JOIN ${RS_IDS_SCHEMA_NM}.LN_LN LN_LN_VW1
        ON LN_LN_VW1.FNM_LN_ID = FILTERED_LN_POS.FNM_LN_ID
        AND LN_LN_VW1.AQSN_ACVY_RPTG_PRD_DT = FILTERED_LN_POS.ACVY_RPTG_PRD_DT
        AND LN_LN_VW1.MD_SRC_SYS_LKUP_OBJ_ID = 9999
    LEFT JOIN MD_DATA_ENUM MD1
        ON MD1.MD_DATA_ENUM_LKUP_OBJ_ID = FILTERED_LN_POS.STAT_TI
        AND MD1.DATA_ENUM_ATTR_NM = 'STAT_TI'
    LEFT JOIN MD_DATA_ENUM MD2
        ON MD2.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN_VW1.FINS_LFC_TI
        AND MD2.DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
    LEFT JOIN MD_DATA_ENUM MD3
        ON MD3.MD_DATA_ENUM_LKUP_OBJ_ID = FILTERED_LN_POS.FCL_LOSS_RSK_TI
        AND MD3.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
    LEFT JOIN MD_DATA_ENUM MD4
        ON MD4.MD_DATA_ENUM_LKUP_OBJ_ID = LN_LN_VW1.FCL_LOSS_RSK_TI
        AND MD4.DATA_ENUM_ATTR_NM = 'FCL_LOSS_RSK_TI'
    LEFT JOIN MD_DATA_ENUM MD5
        ON MD5.MD_DATA_ENUM_LKUP_OBJ_ID = FILTERED_LN_POS.LN_DLQY_RSN_TI
        AND MD5.DATA_ENUM_ATTR_NM = 'LN_DLQY_RSN_TI'
)
SELECT 
    LN_REV_POS_SPST.LN_REVW_ST_SPST_OBJ_ID,
    LN_REV_POS_SPST.FNM_LN_ID,
    LN_REV_POS_SPST.LN_REVW_ID,
    LN_REV_POS_SPST.ACVY_RPTG_PRD_DT,
    LN_REV_POS_SPST.SRC_SYS_INFC_NME_TYP,
    LN_REV_POS_SPST.LN_REVW_ST_TYP,
    LN_REV_POS_SPST.ACVY_RPTG_PRD,
    LN_REV_POS_SPST.LN_DLQ_PRD_CT,
    LN_REV_POS_SPST.LN_FCTRD_ACTL_NET_UPB_AM,
    LN_REV_POS_SPST.FCTRD_ACTL_TOT_UPB_AM,
    LN_REV_POS_SPST.INT_RT,
    LN_REV_POS_SPST.LN_PRIN_FRBRN_BAL_AM,
    LN_REV_POS_SPST.PRIN_REMD_AM,
    LN_REV_POS_SPST.LN_STAT_TYP,
    LN_REV_POS_SPST.LN_STAT_CD,
    ${RS_BATCH_ID} AS bch_lqcs_obj_id,
    'N' AS dwh_rec_del_ind,
    USER AS dwh_rec_cren_usr_id,
    CURRENT_TIMESTAMP AS dwh_rec_cren_dttm,
    USER AS dwh_rec_last_updd_usr_id,
    CURRENT_TIMESTAMP AS dwh_rec_last_updd_dttm,
    LN_REV_POS_SPST.LN_REVW_SRC_SYS_EVNT_NME_TYP,
    LN_REV_POS_SPST.LN_DLQY_RSN_TYP,
    LN_REV_POS_SPST.LN_DLQY_RSN_CD,
    LN_REV_POS_SPST.LN_FCL_LOSS_RSK_TYP,
    LN_REV_POS_SPST.LN_FCL_LOSS_RSK_CD
FROM JOINED_LN_POS LN_REV_POS_SPST;
