SELECT 
    LN_UWRG.FNM_LN_ID AS FNM_LN_ID, 
    AUTOD_UWRG_CASE_ID,
    DU_DRVD.CFILE_SMSS_ID,
    AUTOD_UWRG_SYS_TI,
    TRIM(DATA_ENUM_TP) AS DATA_ENUM_TP,
    LN_CACHE.LN_CUTOFF_DT
FROM 
    ${RS_IDS_SCHEMA_NM}.LN_UWRG
JOIN 
    ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
    ON LN_UWRG.AUTOD_UWRG_SYS_TI = MD_DATA_ENUM_LKUP.MD_DATA_ENUM_LKUP_OBJ_ID
    AND MD_DATA_ENUM_LKUP.MD_SRC_SYS_LKUP_OBJ_ID = 9999
JOIN 
    ${RS_DU_CHR_SCHEMA_NM}.LN_APPL_DU_DRVD DU_DRVD
    ON DU_DRVD.FNM_CFILE_ID = LN_UWRG.AUTOD_UWRG_CASE_ID
    AND DU_DRVD.FNM_LN_ID = LN_UWRG.FNM_LN_ID
LEFT JOIN (
    SELECT 
        LN_LN.FNM_LN_ID,
        NVL(LN_LN.AQSN_DT, LN_STC.NOTE_DT) AS LN_CUTOFF_DT 
    FROM 
        ${RS_IDS_SCHEMA_NM}.LN_LN
    LEFT JOIN 
        ${RS_IDS_SCHEMA_NM}.LN_STC ON LN_LN.FNM_LN_ID = LN_STC.FNM_LN_ID
    WHERE 
        LN_LN.MD_SRC_SYS_LKUP_OBJ_ID = 9999
        AND LN_STC.MD_SRC_SYS_LKUP_OBJ_ID = 9999
        AND LN_STC.FINS_LFC_TI IN (
            SELECT 
                MD_DATA_ENUM_LKUP_OBJ_ID 
            FROM 
                ${RS_IDS_SCHEMA_NM}.MD_DATA_ENUM_LKUP
            WHERE 
                DATA_ENUM_ATTR_NM = 'FINS_LFC_TI'
                AND DATA_ENUM_TP = 'AtClosing'
        )
) LN_CACHE ON LN_CACHE.FNM_LN_ID = LN_UWRG.FNM_LN_ID
LEFT JOIN (
    SELECT DISTINCT FNM_LN_ID
    FROM ${RS_CONV_TGT_DIM_SCHEMA_NM}.LQCS_DU_VND_SPST
) DU_VND_SPST ON LN_UWRG.FNM_LN_ID = DU_VND_SPST.FNM_LN_ID
WHERE 
    DU_VND_SPST.FNM_LN_ID IS NULL;
